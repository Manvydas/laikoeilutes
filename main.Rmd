---
title: "Laiko eilučių laboratorinių darbų užduotis"
subtitle: "Įskaitinių eismo įvykių Lietuvoje analizė"
author: "Linas Šyvis ir Manvydas Sokolovas"
output: html_document
---

```{r, echo=F, message=F, warning=F}
library(fpp)
library(tseries)
library(plyr)
library(car)
library(strucchange)
library(knitr)
```


* **1.Duomenų apžvalga**

```{r, echo = F}
#5 miestu ivykiu skaicius
data <- read.csv2("ivykiai.csv", header = T)
colnames(data) <- c("Data", "Kaunas", "Klaipeda", "Panevezys", "Siauliai", "Vilnius")
#5 miestu ivykiu skaiciaus sumavimas i bendra
ivykiai <- rowSums(data[,2:6])

#kiti regresoriai
kiti <- read.csv2("menesiniai.csv", header = T, skip = 1)

#grafikelis
tseries <- ts(ivykiai, start = c(2009, 1), frequency = 12)
plot(tseries, xlab = "Laikas", ylab = "Įvykių sk.", main = "Įskaitinių eismo įvykių Lietuvoje skaičius", col = "dark green", lwd = 3)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nagrinėti 2009-2017 metų mėnesiniai įskaitinių eismo įvykių Lietuvoje duomenys. Šaltinis - Lietuvos statistikos departamentas. Duomenyse matomas sezoniškumas (įvykių skaičiaus sumažėjimas kiekvienų metų pradžioje ir padidėjimas pabaigoje). Aiškų trendą sunku įžvelgti.

* **2. Kiti rodikliai**

Sezoniškumo ir kitų nuokrypių pagrindinės priežastys tikėtinai yra metų laikas, kuro kainos, alkoholio vartojimas, gyventojų, emigrantų skaičius.

* **3.1.Sezoniškumo įvertinimas**

Duomenyse pastebimas akivaizdus sezoniškumas, todėl jam įvertinti naudosime stl() funkciją, kuri iš laiko eilutės išskiria sezoninę ir trendo komponentes.

```{r, echo = F}
stl <- stl(tseries, s.window="periodic")
plot(stl)

#nusezoninimas
nusez <- tseries - stl$time.series[,"seasonal"]
```

Grafikas patvirtina, kad duomenyse egzistuoja tam tikras sezoniškumas ir trendas ir juos išskiria.

* *3.2.Stacionarumo įvertinimas*

Augmented Dickey-Fuller ir Phillips-Perron testų $H_0$ hipotezė tikrina ar duomenys turi vienetinę šaknį:
```{r, echo=F, warning=F}
adf <- adf.test(nusez)
pp.test(nusez)
```

Kwiatkowski-Phillips-Schmidt-Shin testo mažos p reikšmės rodo, kad duomenys nestacionarūs:
```{r, echo=F, warning=F}
kpss.test(nusez)
```

ADF testo $H_0$ hipotezės atmesti negalime, testo p reikšmė: `adf`. Tačiau kiti testai rodo, jog duomenys yra stacionarūs. Taip gali būti dėl heteroskedastiškumo. Taigi duomenų transformacijų neatliksime.

* **4.1.Tiesinis modelis**

```{r, echo = F, message=F}
#duomenys iki 2016/10, todel ne imami nevisi
kiti$ivykiai <- nusez[1:94]
list <- strsplit(as.character(kiti$laikas), "M")
mod.data <- cbind(ldply(list), kiti[,-1])
colnames(mod.data)[1:2] <- c("Metai", "Menuo")
mod.data$Sausisbalandis <- ifelse(mod.data$Menuo %in% c("01", "02", "03", "04"), 1, 0)
mod.data$kuras <- (mod.data$dyzelinas + mod.data$benzinas_95)/2
```

```{r, echo = F, message=F}
tiesinis1 <- lm(ivykiu_skaicius ~  kuras + krituliai_mm + Sausisbalandis, data = mod.data)
summary(tiesinis1)
ncvTest(tiesinis1)
```

```{r, echo = F}
kable(summary(tiesinis1)$coef, digits = 2)
# Jei p-value > 0.05, tai H0 hipotezė priimama - paklaidos homoskedastiškos.
```

Gautas tiesinis modelis, kurį sudaro statistiškai reikšmingi kintamieji:

 * dyzelinas (dyzelio mėnesinės kainos)

 * valstybėje pirmą kartą registruotos priemonių skaičius

 * krituliai (mm)

 * pseudokintamasis Sausis-balandis, kuris įgija reikšmes: 1 - sausio-balandžio mėn. ir 0 - kovo-gruodžio mėn. Pastarasis regresorius įtrauktas pastebėjus aiškų sezoninį eismo įvykių sumažėjimą metų pradžioje.

* **4.2. Modelio struktūrinių lūžių vertinimas**

Tikrinant, ar modelis turi struktūrinių lūžių, panaudota $breakpoints$ funkcija iš {strucchange} paketo.

```{r, echo=F}
breakpoints(ivykiu_skaicius ~  dyzelinas+ pirma_karta_registruotos_priemones+ krituliai_mm+ Sausisbalandis, data = duom)
```

Duomenyse nepastebėta jokių struktūrinių lūžių.

5.Likučiai

```{r}
plot(tiesinis1$res, type="l", lwd=2)
abline(0,0, lwd=1, col="red")
hist(tiesinis1$res)
```

```{r}
Acf(tiesinis1$res)
pacf(tiesinis1$res)
```

Abu grafikai turi keletą reikšmingų lag'ų

Atliekamas Ljung-Box testas su $H_0$ hipoteze - liekanos yra baltasis triukšmas:

```{r}
balt_p <- Box.test(tiesinis1$res, type="Ljung-Box")
balt_p12 <- Box.test(tiesinis1$res, lag=12, type="Ljung-Box")
```


Gauta p reikšmė `balt_p`. Liekanos nėra baltasis triukšmas. Naudojama "auto.arima" parinkti ARMA(p,q) modelį likučiams:

```{r}
auto.arima(tiesinis1$res, d=0)
lmma1 <- arima(ses[1:92], order = c(1,0,1), xreg = duom[1:92,c("dyzelinas", "pirma_karta_registruotos_priemones", "krituliai_mm", "Sausisbalandis")])
Box.test(lmma1$res, type = "Ljung-Box")
```

Gautas ARMA(1,1) modelis. Liekanas galima įvertinti 

$X_t$ + 0.84$X_{t-1}$ = $Z_t$ - 0.56$Z_{t-1}$

* **6.Kryžminė patikra**

Dabar modelio gerumą tikrinsime naudodami kryžminę patikrą. Algoritmo principas - kiekviename žingsnyje didinti prognozuojamos imties stebėjimų skaičių vienetu ir palyginti prognozes su tikromis reikšmėmis. Atlikus šį algoritmą suskaičiuosime prognozės tikslumą MAE ir MAPE rodikliais.

```{r}
k <- 48 # minimum size for training set
n <- length(visitors) # Total number of observations
e <- visitors*NA # Vector to record one-step forecast errors
for(i in 48:(n-1))
{
train <- ts(visitors[1:i],freq=12)
fit <- ets(train, "MAM", damped=FALSE)
fc <- forecast(fit,h=1)$mean
e[i] <- visitors[i+1]-fc
}
sqrt(mean(e^2,na.rm=TRUE))
```

